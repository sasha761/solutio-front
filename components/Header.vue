<template>
  <header :class="['l-header', { 'is-open': isBurgerOpen }]">
    <div class="u-container">
      <div class="l-header__flex">
        <NuxtLink to="/" class="c-logo">
          <svg width="79" height="20" viewBox="0 0 79 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M10.5365 6.4328C10.4648 5.6978 10.1575 5.1268 9.61441 4.71982C9.07132 4.31283 8.33428 4.10934 7.40327 4.10934C6.77067 4.10934 6.23653 4.20046 5.80087 4.38269C5.36521 4.55885 5.031 4.80486 4.79825 5.12073C4.57147 5.4366 4.45808 5.79499 4.45808 6.1959C4.44614 6.52999 4.51477 6.82157 4.66397 7.07062C4.81914 7.31967 5.031 7.53531 5.29956 7.71754C5.56812 7.8937 5.87846 8.0486 6.23057 8.18223C6.58268 8.3098 6.95866 8.41914 7.35851 8.51025L9.00568 8.91116C9.80538 9.0934 10.5394 9.33637 11.2079 9.64009C11.8763 9.94381 12.4552 10.3174 12.9445 10.7608C13.4339 11.2043 13.8129 11.7267 14.0814 12.328C14.356 12.9294 14.4962 13.6188 14.5022 14.3964C14.4962 15.5383 14.2098 16.5285 13.6428 17.3667C13.0818 18.1989 12.2702 18.8459 11.2079 19.3075C10.1515 19.7631 8.87737 19.9909 7.38537 19.9909C5.90531 19.9909 4.61623 19.7601 3.51812 19.2984C2.42598 18.8368 1.57256 18.1534 0.95786 17.2483C0.349127 16.3371 0.0298399 15.2103 0 13.8679H3.75087C3.79265 14.4935 3.9687 15.0159 4.27904 15.4351C4.59534 15.8481 5.01608 16.161 5.54127 16.3736C6.07242 16.5801 6.6722 16.6834 7.34061 16.6834C7.99709 16.6834 8.56703 16.5862 9.05044 16.3918C9.53981 16.1974 9.91878 15.9271 10.1873 15.5809C10.4559 15.2346 10.5902 14.8368 10.5902 14.3872C10.5902 13.9681 10.4678 13.6158 10.2231 13.3303C9.98442 13.0448 9.63231 12.8018 9.16681 12.6014C8.70728 12.4009 8.1433 12.2187 7.47489 12.0547L5.4786 11.5444C3.9329 11.1617 2.71245 10.5634 1.81725 9.74943C0.922052 8.93546 0.477438 7.83903 0.483406 6.46014C0.477438 5.3303 0.772853 4.3432 1.36965 3.49886C1.97242 2.65452 2.79898 1.99545 3.84934 1.52164C4.89971 1.04784 6.0933 0.810934 7.43013 0.810934C8.79083 0.810934 9.97846 1.04784 10.993 1.52164C12.0135 1.99545 12.8073 2.65452 13.3742 3.49886C13.9412 4.3432 14.2336 5.32119 14.2515 6.4328H10.5365Z" fill="black"/>
            <path d="M21.4499 20C20.0593 20 18.8568 19.6993 17.8422 19.098C16.8336 18.4905 16.0548 17.6462 15.5058 16.5649C14.9567 15.4776 14.6822 14.2172 14.6822 12.7836C14.6822 11.3379 14.9567 10.0744 15.5058 8.99317C16.0548 7.90585 16.8336 7.0615 17.8422 6.46014C18.8568 5.8527 20.0593 5.54898 21.4499 5.54898C22.8404 5.54898 24.04 5.8527 25.0486 6.46014C26.0631 7.0615 26.8449 7.90585 27.394 8.99317C27.943 10.0744 28.2176 11.3379 28.2176 12.7836C28.2176 14.2172 27.943 15.4776 27.394 16.5649C26.8449 17.6462 26.0631 18.4905 25.0486 19.098C24.04 19.6993 22.8404 20 21.4499 20ZM21.4678 16.9932C22.1004 16.9932 22.6285 16.8109 23.0523 16.4465C23.476 16.0759 23.7953 15.5718 24.0101 14.9339C24.2309 14.2961 24.3414 13.5702 24.3414 12.7563C24.3414 11.9423 24.2309 11.2164 24.0101 10.5786C23.7953 9.94078 23.476 9.4366 23.0523 9.06606C22.6285 8.69552 22.1004 8.51025 21.4678 8.51025C20.8292 8.51025 20.2921 8.69552 19.8564 9.06606C19.4267 9.4366 19.1015 9.94078 18.8807 10.5786C18.6658 11.2164 18.5584 11.9423 18.5584 12.7563C18.5584 13.5702 18.6658 14.2961 18.8807 14.9339C19.1015 15.5718 19.4267 16.0759 19.8564 16.4465C20.2921 16.8109 20.8292 16.9932 21.4678 16.9932Z" fill="black"/>
            <path d="M32.7102 1.06606V19.7267H28.8966V1.06606H32.7102Z" fill="black"/>
            <path d="M42.7821 13.7677V5.73121H46.5956V19.7267H42.9343V17.1845H42.791C42.4807 18.0046 41.9645 18.6636 41.2423 19.1617C40.5262 19.6598 39.6519 19.9089 38.6194 19.9089C37.7003 19.9089 36.8917 19.6963 36.1934 19.2711C35.4952 18.8459 34.9491 18.2415 34.5552 17.4579C34.1673 16.6743 33.9704 15.7358 33.9644 14.6424V5.73121H37.7779V13.9499C37.7839 14.776 38.0017 15.429 38.4314 15.9089C38.8611 16.3888 39.437 16.6287 40.1591 16.6287C40.6187 16.6287 41.0484 16.5224 41.4482 16.3098C41.8481 16.0911 42.1704 15.7692 42.415 15.344C42.6657 14.9188 42.788 14.3933 42.7821 13.7677Z" fill="black"/>
            <path d="M55.1591 5.73121V8.64693H46.8786V5.73121H55.1591ZM48.7585 2.37813H52.572V15.426C52.572 15.7844 52.6257 16.0638 52.7331 16.2642C52.8406 16.4586 52.9898 16.5953 53.1807 16.6743C53.3777 16.7532 53.6045 16.7927 53.8611 16.7927C54.0401 16.7927 54.2192 16.7775 54.3982 16.7472C54.5772 16.7107 54.7145 16.6834 54.81 16.6651L55.4098 19.5535C55.2188 19.6143 54.9502 19.6841 54.6041 19.7631C54.258 19.8481 53.8372 19.8998 53.3419 19.918C52.4228 19.9544 51.6171 19.8299 50.9248 19.5444C50.2385 19.2589 49.7044 18.8155 49.3224 18.2141C48.9405 17.6128 48.7525 16.8535 48.7585 15.9362V2.37813Z" fill="black"/>
            <path d="M55.8427 19.7267V5.73121H59.6562V19.7267H55.8427ZM57.7584 3.92711C57.1914 3.92711 56.705 3.73576 56.2992 3.35308C55.8994 2.96431 55.6994 2.49962 55.6994 1.959C55.6994 1.42445 55.8994 0.965832 56.2992 0.583144C56.705 0.194382 57.1914 0 57.7584 0C58.3253 0 58.8088 0.194382 59.2086 0.583144C59.6144 0.965832 59.8173 1.42445 59.8173 1.959C59.8173 2.49962 59.6144 2.96431 59.2086 3.35308C58.8088 3.73576 58.3253 3.92711 57.7584 3.92711Z" fill="black"/>
            <path d="M67.1231 20C65.7326 20 64.53 19.6993 63.5155 19.098C62.5069 18.4905 61.7281 17.6462 61.179 16.5649C60.6299 15.4776 60.3554 14.2172 60.3554 12.7836C60.3554 11.3379 60.6299 10.0744 61.179 8.99317C61.7281 7.90585 62.5069 7.0615 63.5155 6.46014C64.53 5.8527 65.7326 5.54898 67.1231 5.54898C68.5136 5.54898 69.7132 5.8527 70.7218 6.46014C71.7364 7.0615 72.5182 7.90585 73.0672 8.99317C73.6163 10.0744 73.8908 11.3379 73.8908 12.7836C73.8908 14.2172 73.6163 15.4776 73.0672 16.5649C72.5182 17.6462 71.7364 18.4905 70.7218 19.098C69.7132 19.6993 68.5136 20 67.1231 20ZM67.141 16.9932C67.7736 16.9932 68.3018 16.8109 68.7255 16.4465C69.1492 16.0759 69.4685 15.5718 69.6834 14.9339C69.9042 14.2961 70.0146 13.5702 70.0146 12.7563C70.0146 11.9423 69.9042 11.2164 69.6834 10.5786C69.4685 9.94078 69.1492 9.4366 68.7255 9.06606C68.3018 8.69552 67.7736 8.51025 67.141 8.51025C66.5024 8.51025 65.9653 8.69552 65.5297 9.06606C65.1 9.4366 64.7747 9.94078 64.5539 10.5786C64.339 11.2164 64.2316 11.9423 64.2316 12.7563C64.2316 13.5702 64.339 14.2961 64.5539 14.9339C64.7747 15.5718 65.1 16.0759 65.5297 16.4465C65.9653 16.8109 66.5024 16.9932 67.141 16.9932Z" fill="black"/>
            <path d="M76.7989 19.9636C76.2081 19.9636 75.7008 19.751 75.2771 19.3257C74.8593 18.8945 74.6504 18.3781 74.6504 17.7768C74.6504 17.1815 74.8593 16.6712 75.2771 16.246C75.7008 15.8208 76.2081 15.6082 76.7989 15.6082C77.3718 15.6082 77.8731 15.8208 78.3028 16.246C78.7325 16.6712 78.9474 17.1815 78.9474 17.7768C78.9474 18.1777 78.8459 18.5452 78.643 18.8793C78.4461 19.2073 78.1865 19.4715 77.8642 19.672C77.5419 19.8664 77.1868 19.9636 76.7989 19.9636Z" fill="black"/>
          </svg>
        </NuxtLink>
        <nav class="c-menu" v-if="headerMenu.length > 0">
          <span v-for="(menu, index) in headerMenu" :key="index" class="c-menu__item">
            <NuxtLink
              v-if="menu.fragment"
              :to="menu.slug"
              @click.prevent="handleClick(menu)"
            >
              {{ menu.title }}
            </NuxtLink>

            <NuxtLink
              v-else
              :to="{ path: menu.slug }"
            >
              {{ menu.title }}
            </NuxtLink>
          </span>
        </nav>

        <NuxtLink to="/contact" class="u-btn is-black">
          <span>Lets Talk</span>
          <div>
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path fill-rule="evenodd" clip-rule="evenodd" d="M11.7426 5.85865L13.576 4.02516C13.902 3.69914 14.4315 3.69914 14.7575 4.02516L15.9779 5.24554C16.3028 5.57039 16.3028 6.09622 15.9779 6.42107L14.1415 8.25755L11.7426 5.85865ZM10.8587 6.74254L4.29014 13.3111C4.21213 13.3891 4.16832 13.4948 4.16832 13.605V15.835L6.39096 15.835C6.50179 15.835 6.60806 15.791 6.68633 15.7127L13.2576 9.14143L10.8587 6.74254ZM7.57245 16.5944C7.25938 16.9075 6.83429 17.0834 6.39097 17.0834L3.33394 17.0834C3.10353 17.0834 2.91675 16.8971 2.91675 16.6672V13.605C2.91675 13.1643 3.09198 12.7415 3.40402 12.4295L12.6899 3.1435C13.5049 2.32846 14.8286 2.32847 15.6436 3.14352L16.864 4.36389C17.6761 5.17603 17.6762 6.49059 16.864 7.30272L7.57245 16.5944Z"/>
            </svg>
          </div>
        </NuxtLink>

        <div :class="['c-burger', { 'is-open': isBurgerOpen }]" @click="toggleBurger">
          <div class="c-burger__lines">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>

      </div>

      <div class="l-header__mobile" ref="headerMobile">
        <nav class="c-menu" v-if="mobileMenu.length > 0">
          <span v-for="(menu, index) in mobileMenu" :key="index" class="c-menu__item">
            <NuxtLink
              v-if="menu.fragment"
              :to="menu.slug"
              @click.prevent="handleClick(menu)"
            >
              {{ menu.title }}
            </NuxtLink>

            <NuxtLink
              v-else
              :to="{ path: menu.slug }"
            >
              {{ menu.title }}
            </NuxtLink>
          </span>

          <NuxtLink to="/contact" class="c-menu__item">
            Contacts
            <svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path fill-rule="evenodd" clip-rule="evenodd" d="M32.8782 13.0005H20.0001V10.0005H35.9995C37.1041 10.0005 37.9995 10.8959 37.9995 12.0005V27.9999H34.9995V15.1218L12.125 37.9963L10.0037 35.875L32.8782 13.0005Z" fill="#5D4BFF" />
            </svg>
          </NuxtLink>
        </nav>
      </div>
    </div>
  </header>
</template>

<script setup>
import { useAsyncData } from 'nuxt/app'
import { ref, onMounted, nextTick } from 'vue'
import { slideUp, slideDown } from '../assets/js/slideToggle.js'
import { useRouter, useRoute } from 'vue-router';

import Api from '@/api/Axios'
import VueScrollTo from 'vue-scrollto';

const router = useRouter();
const route = useRoute();


const isBurgerOpen = ref(false);
const headerMobile = ref(null);

const headerHeight = ref(0);

const { data: headerMenu } = await useAsyncData('headerMenu', () => 
  Api.get('menu/get_menu_header')
    .then(response => response.data)
    .catch(err => {
      console.error('Error fetching menu:', err)
      return []
    })
);

const { data: mobileMenu} = await useAsyncData('mobileMenu', () => 
  Api.get('menu/get_menu_mobile')
    .then(response => response.data)
    .catch(err => {
      console.error('Error fetching menu:', err)
      return []
    })
);

const toggleBurger = () => {
  isBurgerOpen.value = !isBurgerOpen.value

  if (isBurgerOpen.value) {
    document.body.classList.add('is-mobile-menu-open');
    slideDown(headerMobile.value, 400) 
  } else {
    document.body.classList.remove('is-mobile-menu-open');
    slideUp(headerMobile.value, 400)   
  }
}

const handleClick = (menu) => {
  const targetSlug = menu.slug;
  const fragment = menu.fragment ? `${menu.fragment}` : null;

  if (isBurgerOpen.value) {
    toggleBurger();
  }
  
  if (route.path === targetSlug) {
    scrollToSection(fragment);
  } else {
    router.push({ path: targetSlug }).then(() => {
      nextTick(() => {
        window.setTimeout(() => {
          scrollToSection(fragment);
        }, 1000);
      });
    });
  }
};

const scrollToSection = (fragmentId) => {
  if (fragmentId) {
    const section = document.querySelector(fragmentId);
    if (!section) {
      console.warn(`Section with id ${fragmentId} not found on the page.`);
      return; // Если секция не найдена, прекращаем выполнение
    }
    VueScrollTo.scrollTo(fragmentId, 800, {
      offset: -headerHeight.value - 20 || 0, // Учет высоты хедера
      easing: 'ease-in-out',
    });
  }
};

// Опционально: если нужно скроллить после монтирования компонента
onMounted(() => {
  const hash = route.hash;
  if (hash) {
    nextTick(() => {
      scrollToSection(hash);
    });
  }

  if (process.client) {
    const headerElement = document.querySelector('header');
    if (headerElement) {
      headerHeight.value = headerElement.offsetHeight; // Получаем высоту хедера
    }
  }
});

</script>